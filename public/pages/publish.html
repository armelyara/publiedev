<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0ea5e9">
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/svg+xml" href="/assets/icons/favicon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <title>Soumettre - PublieDev</title>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container header-content">
            <a href="/" class="logo">
                <div class="logo-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="16 18 22 12 16 6"></polyline>
                        <polyline points="8 6 2 12 8 18"></polyline>
                    </svg>
                </div>
                <span>PublieDev</span>
            </a>
            <nav class="nav desktop-only">
                <a href="/pages/explore.html">Explorer</a>
                <div id="authNav">
                    <a href="/pages/login.html" class="btn btn-primary">Connexion</a>
                </div>
            </nav>
        </div>
    </header>

    <main>
        <div class="container" style="padding: 2rem 1rem;">
            <div style="max-width: 48rem; margin: 0 auto;">
                <h1 style="font-size: 1.875rem; font-weight: 700; margin-bottom: 0.5rem;">Nouvelle publication</h1>
                <p style="color: var(--gray-600); margin-bottom: 2rem;">Partagez votre projet avec la communauté des développeurs ivoiriens</p>

                <!-- État de chargement -->
                <div id="loadingState" style="text-align: center; padding: 4rem 2rem;">
                    <p style="color: var(--gray-500);">Chargement...</p>
                </div>

                <!-- Vérification authentification -->
                <div id="authRequired" style="display: none; text-align: center; padding: 4rem 2rem;">
                    <h2 style="margin-bottom: 1rem;">Connexion requise</h2>
                    <p style="color: var(--gray-600); margin-bottom: 1.5rem;">Vous devez être connecté pour soumettre du contenu.</p>
                    <a href="/pages/login.html" class="btn btn-primary">Se connecter</a>
                </div>

                <!-- Formulaire -->
                <form id="publishForm" style="display: none;">
                    <div id="errorAlert" class="alert alert-error" style="display: none;"></div>
                    <div id="successAlert" class="alert alert-success" style="display: none;"></div>

                    <!-- Type -->
                    <div style="background: var(--white); border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1rem; border: 1px solid var(--gray-100);">
                        <label style="display: block; font-weight: 500; margin-bottom: 0.75rem;">Type de publication</label>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem;">
                            <button type="button" class="type-btn active" data-type="article">Article</button>
                            <button type="button" class="type-btn" data-type="app-mobile">App Mobile</button>
                            <button type="button" class="type-btn" data-type="app-web">App Web</button>
                            <button type="button" class="type-btn" data-type="api">API</button>
                        </div>
                        <input type="hidden" id="type" value="article">
                    </div>

                    <!-- Champs communs -->
                    <div id="commonFields">
                        <!-- Titre -->
                        <div class="form-group" style="background: var(--white); border-radius: 0.75rem; padding: 1.5rem; border: 1px solid var(--gray-100);">
                            <label for="title">Titre *</label>
                            <input type="text" id="title" placeholder="Nom de votre projet" required>
                        </div>

                        <!-- Description -->
                        <div class="form-group" style="background: var(--white); border-radius: 0.75rem; padding: 1.5rem; border: 1px solid var(--gray-100);">
                            <label for="description">Description courte *</label>
                            <textarea id="description" rows="3" placeholder="Décrivez brièvement votre projet..." required></textarea>
                        </div>
                    </div>

                    <!-- Champs spécifiques Article -->
                    <div id="articleFields" class="type-fields">
                        <div class="form-group" style="background: var(--white); border-radius: 0.75rem; padding: 1.5rem; border: 1px solid var(--gray-100);">
                            <label for="articleAuthors">Auteurs (séparés par des virgules)</label>
                            <input type="text" id="articleAuthors" placeholder="Nom A, Nom B, Nom C...">
                        </div>

                        <div class="form-group" style="background: var(--white); border-radius: 0.75rem; padding: 1.5rem; border: 1px solid var(--gray-100);">
                            <label for="articleAbstract">Résumé (Abstract) *</label>
                            <textarea id="articleAbstract" rows="5" placeholder="Résumé de l'article..." required></textarea>
                        </div>

                        <div class="form-group" style="background: var(--white); border-radius: 0.75rem; padding: 1.5rem; border: 1px solid var(--gray-100);">
                            <label for="articlePdf">Document PDF *</label>
                            <input type="file" id="articlePdf" accept=".pdf" required>
                            <small style="color: var(--gray-500); display: block; margin-top: 0.25rem;">Format PDF uniquement, max 10MB</small>
                        </div>

                        <div class="form-group" style="background: var(--white); border-radius: 0.75rem; padding: 1.5rem; border: 1px solid var(--gray-100);">
                            <label for="articleKeywords">Mots-clés (séparés par des virgules)</label>
                            <input type="text" id="articleKeywords" placeholder="machine learning, NLP, python...">
                        </div>

                        <div class="form-group" style="background: var(--white); border-radius: 0.75rem; padding: 1.5rem; border: 1px solid var(--gray-100);">
                            <label for="articleDoi">DOI (optionnel)</label>
                            <input type="text" id="articleDoi" placeholder="10.1234/exemple">
                        </div>
                    </div>

                    <!-- Champs spécifiques App Mobile -->
                    <div id="appMobileFields" class="type-fields" style="display: none;">
                        <div style="background: var(--white); border-radius: 0.75rem; padding: 1.5rem; border: 1px solid var(--gray-100); margin-bottom: 1.5rem;">
                            <!-- Contenu -->
                            <div class="form-group"
                                style="background: var(--white); border-radius: 0.75rem; padding: 1.5rem; border: 1px solid var(--gray-100);">
                                <label for="content">Contenu détaillé *</label>
                                <textarea id="content" rows="10" placeholder="Détaillez votre projet..." required
                                    style="font-family: monospace;"></textarea>
                            </div>
                            <h3 style="font-weight: 500; margin-bottom: 1rem;">Liens</h3>
                            <div class="form-group">
                                <label for="playStoreUrl">URL Play Store</label>
                                <input type="url" id="playStoreUrl" placeholder="https://play.google.com/store/apps/details?id=...">
                            </div>
                            <div class="form-group">
                                <label for="appStoreUrl">URL App Store</label>
                                <input type="url" id="appStoreUrl" placeholder="https://apps.apple.com/app/...">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="mobileGithubUrl">URL GitHub</label>
                                <input type="url" id="mobileGithubUrl" placeholder="https://github.com/...">
                            </div>
                        </div>
                    </div>

                    <!-- Champs spécifiques App Web -->
                    <div id="appWebFields" class="type-fields" style="display: none;">
                        <div style="background: var(--white); border-radius: 0.75rem; padding: 1.5rem; border: 1px solid var(--gray-100); margin-bottom: 1.5rem;">
                            <h3 style="font-weight: 500; margin-bottom: 1rem;">Liens</h3>
                            <div class="form-group">
                                <label for="webDemoUrl">URL de démo</label>
                                <input type="url" id="webDemoUrl" placeholder="https://...">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="webGithubUrl">URL GitHub</label>
                                <input type="url" id="webGithubUrl" placeholder="https://github.com/...">
                            </div>
                        </div>
                    </div>

                    <!-- Champs spécifiques API -->
                    <div id="apiFields" class="type-fields" style="display: none;">
                        <div style="background: var(--white); border-radius: 0.75rem; padding: 1.5rem; border: 1px solid var(--gray-100); margin-bottom: 1.5rem;">
                            <h3 style="font-weight: 500; margin-bottom: 1rem;">Liens</h3>
                            <div class="form-group">
                                <label for="apiDocsUrl">URL Documentation</label>
                                <input type="url" id="apiDocsUrl" placeholder="https://docs.example.com/...">
                            </div>
                            <div class="form-group">
                                <label for="apiBaseUrl">URL de base de l'API</label>
                                <input type="url" id="apiBaseUrl" placeholder="https://api.example.com/v1">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="apiGithubUrl">URL GitHub</label>
                                <input type="url" id="apiGithubUrl" placeholder="https://github.com/...">
                            </div>
                        </div>
                    </div>

                    <!-- Tags (pour tous les types) -->
                    <div id="tagsSection">
                        <div class="form-group" style="background: var(--white); border-radius: 0.75rem; padding: 1.5rem; border: 1px solid var(--gray-100);">
                            <label for="tags">Tags (séparés par des virgules)</label>
                            <input type="text" id="tags" placeholder="fintech, mobile, ecommerce...">
                        </div>
                    </div>

                    <!-- Actions -->
                    <div id="actionsSection">
                        <div style="display: flex; justify-content: flex-end; gap: 1rem;">
                            <a href="/" class="btn btn-secondary">Annuler</a>
                            <button type="submit" class="btn btn-primary" id="submitBtn">Soumettre</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <style>
        .type-btn {
            padding: 0.75rem;
            border: 1px solid var(--gray-200);
            border-radius: 0.5rem;
            font-size: 0.75rem;
            font-weight: 500;
            background: var(--white);
            transition: all 0.2s;
        }
        .type-btn:hover {
            border-color: var(--bluesky-300);
        }
        .type-btn.active {
            border-color: var(--bluesky-500);
            background: var(--bluesky-50);
            color: var(--bluesky-600);
        }
    </style>

    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-storage-compat.js"></script>
    <script src="/js/config.js"></script>
    <script src="/js/services/firebase.js"></script>
    <script src="/js/utils/security.js"></script>
    <script src="/js/services/auth.js"></script>

    <script>
        const form = document.getElementById('publishForm');
        const authRequired = document.getElementById('authRequired');
        const loadingState = document.getElementById('loadingState');
        const errorAlert = document.getElementById('errorAlert');
        const successAlert = document.getElementById('successAlert');
        const submitBtn = document.getElementById('submitBtn');

        // Vérifier l'authentification
        auth.onAuthStateChanged((user) => {
            currentUser = user;
            loadingState.style.display = 'none';
            if (user) {
                form.style.display = 'block';
                authRequired.style.display = 'none';
            } else {
                form.style.display = 'none';
                authRequired.style.display = 'block';
            }
        });

        // Gestion des boutons de type
        document.querySelectorAll('.type-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                const type = btn.dataset.type;
                document.getElementById('type').value = type;

                // Afficher les champs communs
                document.getElementById('commonFields').style.display = 'block';
                document.getElementById('tagsSection').style.display = 'block';
                document.getElementById('actionsSection').style.display = 'block';

                // Masquer tous les champs spécifiques
                document.querySelectorAll('.type-fields').forEach(f => f.style.display = 'none');

                // Afficher les champs du type sélectionné
                const fieldsMap = {
                    'article': 'articleFields',
                    'app-mobile': 'appMobileFields',
                    'app-web': 'appWebFields',
                    'api': 'apiFields'
                };
                document.getElementById(fieldsMap[type]).style.display = 'block';
            });
        });

        // Soumission du formulaire
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            await publish();
        });

        // Fonction pour générer les mots-clés de recherche
        function generateKeywords(text) {
            return text.toLowerCase()
                .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                .split(/\s+/)
                .filter(word => word.length > 2);
        }

        // Publier
        async function publish() {
            errorAlert.style.display = 'none';
            successAlert.style.display = 'none';
            submitBtn.disabled = true;
            submitBtn.textContent = 'Envoi en cours...';

            try {
                if (!currentUser) {
                    throw new Error('Vous devez être connecté pour soumettre.');
                }

                const type = document.getElementById('type').value;
                if (!type) {
                    throw new Error('Veuillez sélectionner un type de publication');
                }

                const title = document.getElementById('title').value.trim();
                const description = document.getElementById('description').value.trim();
                const tags = document.getElementById('tags').value
                    .split(',').map(t => t.trim().toLowerCase()).filter(t => t);

                const slug = title.toLowerCase()
                    .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                    .replace(/[^a-z0-9]+/g, '-')
                    .replace(/(^-|-$)/g, '');

                const data = {
                    title,
                    slug,
                    description,
                    type,
                    tags,
                    keywords: generateKeywords(title + ' ' + description + ' ' + tags.join(' ')),
                    authorId: currentUser.uid,
                    authorName: currentUser.displayName || '',
                    authorEmail: currentUser.email || '',
                    status: 'pending',
                    views: 0,
                    likes: 0,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                // Champs spécifiques selon le type
                if (type === 'article') {
                    const pdfInput = document.getElementById('articlePdf');
                    if (pdfInput.files.length > 0) {
                        const file = pdfInput.files[0];
                        if (file.size > 10 * 1024 * 1024) {
                            throw new Error('Le fichier PDF ne doit pas dépasser 10MB');
                        }
                        submitBtn.textContent = 'Upload du PDF...';
                        const storageRef = storage.ref(`publications/${currentUser.uid}/${Date.now()}_${file.name}`);
                        await storageRef.put(file);
                        data.pdfUrl = await storageRef.getDownloadURL();
                    }
                    data.authors = document.getElementById('articleAuthors').value.split(',').map(a => a.trim()).filter(a => a);
                    data.abstract = document.getElementById('articleAbstract').value.trim();
                    data.articleKeywords = document.getElementById('articleKeywords').value.split(',').map(k => k.trim().toLowerCase()).filter(k => k);
                    data.doi = document.getElementById('articleDoi').value.trim();

                } else if (type === 'app-mobile') {
                    data.playStoreUrl = document.getElementById('playStoreUrl').value.trim();
                    data.appStoreUrl = document.getElementById('appStoreUrl').value.trim();
                    data.githubUrl = document.getElementById('mobileGithubUrl').value.trim();

                } else if (type === 'app-web') {
                    data.demoUrl = document.getElementById('webDemoUrl').value.trim();
                    data.githubUrl = document.getElementById('webGithubUrl').value.trim();

                } else if (type === 'api') {
                    data.docsUrl = document.getElementById('apiDocsUrl').value.trim();
                    data.baseUrl = document.getElementById('apiBaseUrl').value.trim();
                    data.githubUrl = document.getElementById('apiGithubUrl').value.trim();
                }

                submitBtn.textContent = 'Création...';
                await db.collection('publications').add(data);

                successAlert.textContent = 'Votre publication a été soumise pour validation. Elle sera visible après approbation.';
                successAlert.style.display = 'block';
                form.reset();
                document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
                document.getElementById('commonFields').style.display = 'none';
                document.querySelectorAll('.type-fields').forEach(f => f.style.display = 'none');
                document.getElementById('tagsSection').style.display = 'none';
                document.getElementById('actionsSection').style.display = 'none';

                submitBtn.disabled = false;
                submitBtn.textContent = 'Soumettre';

            } catch (error) {
                console.error('Erreur:', error);
                errorAlert.textContent = error.message || 'Une erreur est survenue';
                errorAlert.style.display = 'block';
                submitBtn.disabled = false;
                submitBtn.textContent = 'Soumettre';
            }
        }
    </script>
</body>
</html>
