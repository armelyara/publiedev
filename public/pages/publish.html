<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0ea5e9">
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/svg+xml" href="/assets/icons/favicon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <title>Publier - PublieDev</title>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container header-content">
            <a href="/" class="logo">
                <div class="logo-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="16 18 22 12 16 6"></polyline>
                        <polyline points="8 6 2 12 8 18"></polyline>
                    </svg>
                </div>
                <span>PublieDev</span>
            </a>
            <nav class="nav desktop-only">
                <a href="/pages/explore.html">Explorer</a>
                <div id="authNav">
                    <a href="/pages/login.html" class="btn btn-primary">Connexion</a>
                </div>
            </nav>
        </div>
    </header>

    <main>
        <div class="container" style="padding: 2rem 1rem;">
            <div style="max-width: 48rem; margin: 0 auto;">
                <h1 style="font-size: 1.875rem; font-weight: 700; margin-bottom: 0.5rem;">Nouvelle publication</h1>
                <p style="color: var(--gray-600); margin-bottom: 2rem;">Partagez votre projet avec la communauté des développeurs ivoiriens</p>

                <!-- Vérification authentification -->
                <div id="authRequired" style="display: none; text-align: center; padding: 4rem 2rem;">
                    <h2 style="margin-bottom: 1rem;">Connexion requise</h2>
                    <p style="color: var(--gray-600); margin-bottom: 1.5rem;">Vous devez être connecté pour publier du contenu.</p>
                    <a href="/pages/login.html" class="btn btn-primary">Se connecter</a>
                </div>

                <!-- Formulaire -->
                <form id="publishForm" style="display: none;">
                    <div id="errorAlert" class="alert alert-error" style="display: none;"></div>
                    <div id="successAlert" class="alert alert-success" style="display: none;"></div>

                    <!-- Type de publication -->
                    <div class="form-card">
                        <label style="display: block; font-weight: 500; margin-bottom: 0.75rem;">Type de publication</label>
                        <div class="type-grid">
                            <button type="button" class="type-btn" data-type="article">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                    <polyline points="14 2 14 8 20 8"></polyline>
                                </svg>
                                Article
                            </button>
                            <button type="button" class="type-btn" data-type="app-mobile">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect>
                                    <line x1="12" y1="18" x2="12.01" y2="18"></line>
                                </svg>
                                App Mobile
                            </button>
                            <button type="button" class="type-btn" data-type="app-web">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <line x1="2" y1="12" x2="22" y2="12"></line>
                                    <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                                </svg>
                                App Web
                            </button>
                            <button type="button" class="type-btn" data-type="api">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="16 18 22 12 16 6"></polyline>
                                    <polyline points="8 6 2 12 8 18"></polyline>
                                </svg>
                                API
                            </button>
                        </div>
                        <input type="hidden" id="type" value="">
                    </div>

                    <!-- Champs communs -->
                    <div id="commonFields" style="display: none;">
                        <!-- Titre -->
                        <div class="form-card">
                            <div class="form-group">
                                <label for="title">Titre *</label>
                                <input type="text" id="title" placeholder="Nom de votre projet" required>
                            </div>
                        </div>

                        <!-- Description -->
                        <div class="form-card">
                            <div class="form-group">
                                <label for="description">Description courte *</label>
                                <textarea id="description" rows="3" placeholder="Décrivez brièvement votre projet (10-200 caractères)..." required></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Champs spécifiques Article -->
                    <div id="articleFields" class="type-fields" style="display: none;">
                        <div class="form-card">
                            <h3 style="font-weight: 500; margin-bottom: 1rem; color: var(--bluesky-600);">Article scientifique / technique</h3>

                            <div class="form-group">
                                <label for="articleAuthors">Auteurs (séparés par des virgules)</label>
                                <input type="text" id="articleAuthors" placeholder="Nom A, Nom B, Nom C...">
                            </div>

                            <div class="form-group">
                                <label for="articleAbstract">Résumé (Abstract) *</label>
                                <textarea id="articleAbstract" rows="5" placeholder="Résumé de l'article..." required></textarea>
                            </div>

                            <div class="form-group">
                                <label for="articlePdf">Document PDF *</label>
                                <input type="file" id="articlePdf" accept=".pdf" required>
                                <small style="color: var(--gray-500);">Format PDF uniquement, max 10MB</small>
                            </div>

                            <div class="form-group">
                                <label for="articleKeywords">Mots-clés (séparés par des virgules)</label>
                                <input type="text" id="articleKeywords" placeholder="machine learning, NLP, python...">
                            </div>

                            <div class="form-group">
                                <label for="articleDoi">DOI (optionnel)</label>
                                <input type="text" id="articleDoi" placeholder="10.1234/exemple">
                            </div>
                        </div>
                    </div>

                    <!-- Champs spécifiques App Mobile -->
                    <div id="appMobileFields" class="type-fields" style="display: none;">
                        <div class="form-card">
                            <h3 style="font-weight: 500; margin-bottom: 1rem; color: var(--bluesky-600);">Application Mobile</h3>

                            <div class="form-group">
                                <label for="mobileContent">Description détaillée</label>
                                <textarea id="mobileContent" rows="6" placeholder="Fonctionnalités, cas d'usage..."></textarea>
                            </div>

                            <div class="form-group">
                                <label for="mobilePlaystore">Lien Google Play Store</label>
                                <input type="url" id="mobilePlaystore" placeholder="https://play.google.com/store/apps/...">
                            </div>

                            <div class="form-group">
                                <label for="mobileAppstore">Lien Apple App Store</label>
                                <input type="url" id="mobileAppstore" placeholder="https://apps.apple.com/...">
                            </div>

                            <div class="form-group">
                                <label for="mobileTechnologies">Technologies (séparées par des virgules)</label>
                                <input type="text" id="mobileTechnologies" placeholder="Flutter, React Native, Swift...">
                            </div>

                            <div class="form-group">
                                <label for="mobileGithub">URL GitHub (optionnel)</label>
                                <input type="url" id="mobileGithub" placeholder="https://github.com/...">
                            </div>

                            <div class="form-group">
                                <label for="mobileCover">Image de couverture (URL)</label>
                                <input type="url" id="mobileCover" placeholder="https://...">
                            </div>
                        </div>
                    </div>

                    <!-- Champs spécifiques App Web -->
                    <div id="appWebFields" class="type-fields" style="display: none;">
                        <div class="form-card">
                            <h3 style="font-weight: 500; margin-bottom: 1rem; color: var(--bluesky-600);">Application Web</h3>

                            <div class="form-group">
                                <label for="webContent">Description détaillée</label>
                                <textarea id="webContent" rows="6" placeholder="Fonctionnalités, cas d'usage..."></textarea>
                            </div>

                            <div class="form-group">
                                <label for="webDemoUrl">URL de l'application *</label>
                                <input type="url" id="webDemoUrl" placeholder="https://..." required>
                            </div>

                            <div class="form-group">
                                <label for="webPlaystore">Lien Google Play Store (PWA)</label>
                                <input type="url" id="webPlaystore" placeholder="https://play.google.com/store/apps/...">
                            </div>

                            <div class="form-group">
                                <label for="webAppstore">Lien Apple App Store (PWA)</label>
                                <input type="url" id="webAppstore" placeholder="https://apps.apple.com/...">
                            </div>

                            <div class="form-group">
                                <label for="webTechnologies">Technologies (séparées par des virgules)</label>
                                <input type="text" id="webTechnologies" placeholder="React, Vue.js, Node.js...">
                            </div>

                            <div class="form-group">
                                <label for="webGithub">URL GitHub (optionnel)</label>
                                <input type="url" id="webGithub" placeholder="https://github.com/...">
                            </div>

                            <div class="form-group">
                                <label for="webCover">Image de couverture (URL)</label>
                                <input type="url" id="webCover" placeholder="https://...">
                            </div>
                        </div>
                    </div>

                    <!-- Champs spécifiques API -->
                    <div id="apiFields" class="type-fields" style="display: none;">
                        <div class="form-card">
                            <h3 style="font-weight: 500; margin-bottom: 1rem; color: var(--bluesky-600);">API</h3>

                            <div class="form-group">
                                <label for="apiContent">Documentation / Description *</label>
                                <textarea id="apiContent" rows="8" placeholder="Endpoints, authentification, exemples..." required style="font-family: monospace;"></textarea>
                            </div>

                            <div class="form-group">
                                <label for="apiBaseUrl">URL de base de l'API</label>
                                <input type="url" id="apiBaseUrl" placeholder="https://api.exemple.com/v1">
                            </div>

                            <div class="form-group">
                                <label for="apiDocsUrl">URL Documentation</label>
                                <input type="url" id="apiDocsUrl" placeholder="https://docs.exemple.com">
                            </div>

                            <div class="form-group">
                                <label for="apiTechnologies">Technologies (séparées par des virgules)</label>
                                <input type="text" id="apiTechnologies" placeholder="Node.js, Python, GraphQL...">
                            </div>

                            <div class="form-group">
                                <label for="apiGithub">URL GitHub (optionnel)</label>
                                <input type="url" id="apiGithub" placeholder="https://github.com/...">
                            </div>
                        </div>
                    </div>

                    <!-- Tags communs -->
                    <div id="tagsSection" class="form-card" style="display: none;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="tags">Tags (séparés par des virgules)</label>
                            <input type="text" id="tags" placeholder="fintech, mobile, ecommerce...">
                        </div>
                    </div>

                    <!-- Actions -->
                    <div id="actionsSection" style="display: none; margin-top: 1.5rem;">
                        <p style="font-size: 0.875rem; color: var(--gray-500); margin-bottom: 1rem;">
                            Votre publication sera soumise à validation avant d'apparaître publiquement.
                        </p>
                        <div style="display: flex; justify-content: flex-end; gap: 1rem;">
                            <button type="submit" class="btn btn-primary" id="submitBtn">Soumettre pour validation</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <style>
        .form-card {
            background: var(--white);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border: 1px solid var(--gray-100);
        }
        .type-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }
        @media (min-width: 640px) {
            .type-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        .type-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem;
            border: 2px solid var(--gray-200);
            border-radius: 0.75rem;
            font-size: 0.875rem;
            font-weight: 500;
            background: var(--white);
            transition: all 0.2s;
            color: var(--gray-600);
        }
        .type-btn:hover {
            border-color: var(--bluesky-300);
            color: var(--bluesky-500);
        }
        .type-btn.active {
            border-color: var(--bluesky-500);
            background: var(--bluesky-50);
            color: var(--bluesky-600);
        }
        .type-btn svg {
            opacity: 0.7;
        }
        .type-btn.active svg {
            opacity: 1;
        }
    </style>

    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-storage-compat.js"></script>
    <script src="/js/config.js"></script>
    <script src="/js/services/firebase.js"></script>
    <script src="/js/utils/security.js"></script>
    <script src="/js/services/auth.js"></script>

    <script>
        const form = document.getElementById('publishForm');
        const authRequired = document.getElementById('authRequired');
        const errorAlert = document.getElementById('errorAlert');
        const successAlert = document.getElementById('successAlert');
        const submitBtn = document.getElementById('submitBtn');
        let currentUser = null;

        // Vérifier l'authentification
        auth.onAuthStateChanged((user) => {
            currentUser = user;
            if (user) {
                form.style.display = 'block';
                authRequired.style.display = 'none';
            } else {
                form.style.display = 'none';
                authRequired.style.display = 'block';
            }
        });

        // Gestion des boutons de type
        document.querySelectorAll('.type-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                const type = btn.dataset.type;
                document.getElementById('type').value = type;

                // Afficher les champs communs
                document.getElementById('commonFields').style.display = 'block';
                document.getElementById('tagsSection').style.display = 'block';
                document.getElementById('actionsSection').style.display = 'block';

                // Masquer tous les champs spécifiques
                document.querySelectorAll('.type-fields').forEach(f => f.style.display = 'none');

                // Afficher les champs du type sélectionné
                const fieldsMap = {
                    'article': 'articleFields',
                    'app-mobile': 'appMobileFields',
                    'app-web': 'appWebFields',
                    'api': 'apiFields'
                };
                document.getElementById(fieldsMap[type]).style.display = 'block';
            });
        });

        // Soumission du formulaire
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            await publish();
        });

        // Publier
        async function publish() {
            errorAlert.style.display = 'none';
            successAlert.style.display = 'none';
            submitBtn.disabled = true;
            submitBtn.textContent = 'Envoi en cours...';

            try {
                // Vérification de sécurité: utilisateur authentifié
                if (!currentUser) {
                    throw new Error('Vous devez être connecté pour publier. Veuillez vous connecter.');
                }

                const type = document.getElementById('type').value;
                if (!type) {
                    throw new Error('Veuillez sélectionner un type de publication');
                }

                const title = document.getElementById('title').value.trim();
                const description = document.getElementById('description').value.trim();
                const tags = document.getElementById('tags').value
                    .split(',').map(t => t.trim().toLowerCase()).filter(t => t);

                // Générer le slug
                const slug = title.toLowerCase()
                    .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                    .replace(/[^a-z0-9]+/g, '-')
                    .replace(/(^-|-$)/g, '');

                // Données de base
                const data = {
                    title,
                    slug,
                    description,
                    type,
                    tags,
                    keywords: generateKeywords(title + ' ' + description + ' ' + tags.join(' ')),
                    authorId: currentUser.uid,
                    authorName: currentUser.displayName || '',
                    authorEmail: currentUser.email || '',
                    status: 'pending',
                    views: 0,
                    likes: 0,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                // Ajouter les champs spécifiques selon le type
                if (type === 'article') {
                    // Upload PDF
                    const pdfFile = document.getElementById('articlePdf').files[0];
                    if (!pdfFile) {
                        throw new Error('Veuillez sélectionner un fichier PDF');
                    }
                    if (pdfFile.size > 10 * 1024 * 1024) {
                        throw new Error('Le fichier PDF ne doit pas dépasser 10MB');
                    }

                    submitBtn.textContent = 'Upload du PDF...';
                    const pdfRef = storage.ref(`publications/${Date.now()}_${pdfFile.name}`);
                    await pdfRef.put(pdfFile);
                    const pdfUrl = await pdfRef.getDownloadURL();

                    data.authors = document.getElementById('articleAuthors').value
                        .split(',').map(a => a.trim()).filter(a => a);
                    data.abstract = document.getElementById('articleAbstract').value.trim();
                    data.pdfUrl = pdfUrl;
                    data.articleKeywords = document.getElementById('articleKeywords').value
                        .split(',').map(k => k.trim().toLowerCase()).filter(k => k);
                    data.doi = document.getElementById('articleDoi').value.trim();

                } else if (type === 'app-mobile') {
                    data.content = document.getElementById('mobileContent').value.trim();
                    data.playstoreUrl = document.getElementById('mobilePlaystore').value.trim();
                    data.appstoreUrl = document.getElementById('mobileAppstore').value.trim();
                    data.technologies = document.getElementById('mobileTechnologies').value
                        .split(',').map(t => t.trim()).filter(t => t);
                    data.githubUrl = document.getElementById('mobileGithub').value.trim();
                    data.coverImage = document.getElementById('mobileCover').value.trim();

                } else if (type === 'app-web') {
                    data.content = document.getElementById('webContent').value.trim();
                    data.demoUrl = document.getElementById('webDemoUrl').value.trim();
                    data.playstoreUrl = document.getElementById('webPlaystore').value.trim();
                    data.appstoreUrl = document.getElementById('webAppstore').value.trim();
                    data.technologies = document.getElementById('webTechnologies').value
                        .split(',').map(t => t.trim()).filter(t => t);
                    data.githubUrl = document.getElementById('webGithub').value.trim();
                    data.coverImage = document.getElementById('webCover').value.trim();

                } else if (type === 'api') {
                    data.content = document.getElementById('apiContent').value.trim();
                    data.apiBaseUrl = document.getElementById('apiBaseUrl').value.trim();
                    data.docsUrl = document.getElementById('apiDocsUrl').value.trim();
                    data.technologies = document.getElementById('apiTechnologies').value
                        .split(',').map(t => t.trim()).filter(t => t);
                    data.githubUrl = document.getElementById('apiGithub').value.trim();
                }

                // Créer la publication
                submitBtn.textContent = 'Création...';
                const docRef = await db.collection('publications').add(data);

                successAlert.textContent = 'Publication soumise avec succès! Elle sera visible après validation.';
                successAlert.style.display = 'block';

                // Reset form
                form.reset();
                document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
                document.getElementById('commonFields').style.display = 'none';
                document.querySelectorAll('.type-fields').forEach(f => f.style.display = 'none');
                document.getElementById('tagsSection').style.display = 'none';
                document.getElementById('actionsSection').style.display = 'none';

                submitBtn.disabled = false;
                submitBtn.textContent = 'Soumettre pour validation';

            } catch (error) {
                console.error('Erreur publication:', error);
                errorAlert.textContent = error.message || 'Une erreur est survenue';
                errorAlert.style.display = 'block';
                submitBtn.disabled = false;
                submitBtn.textContent = 'Soumettre pour validation';
            }
        }

        // Générer des mots-clés pour la recherche
        function generateKeywords(text) {
            const words = text.toLowerCase()
                .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                .split(/\s+/)
                .filter(w => w.length > 2);
            return [...new Set(words)].slice(0, 30);
        }
    </script>
</body>
</html>
